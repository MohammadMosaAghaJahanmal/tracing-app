//- views/reset-password.pug
doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Reset Password - Blood Donors Network
    style.
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #FDF2F2;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 400px;
      }

      .card {
        background: #FFFFFF;
        border-radius: 20px;
        padding: 32px;
        border: 1px solid #FFE6E6;
        box-shadow: 0 6px 16px rgba(231, 60, 60, 0.1);
        margin-bottom: 24px;
      }

      .header {
        text-align: center;
        margin-bottom: 32px;
      }

      .blood-drop {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .title {
        font-size: 28px;
        font-weight: 800;
        color: #1E1E1E;
        margin-bottom: 8px;
      }

      .subtitle {
        font-size: 16px;
        color: #7E7E7E;
        font-weight: 500;
        line-height: 1.5;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .label {
        display: block;
        color: #1E1E1E;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
        text-align: left;
      }

      .input {
        width: 100%;
        padding: 16px;
        border: 1.5px solid #FFE6E6;
        border-radius: 14px;
        background: #FFFBFB;
        font-size: 16px;
        font-weight: 500;
        color: #1E1E1E;
        transition: border-color 0.2s;
      }

      .input:focus {
        outline: none;
        border-color: #E73C3C;
      }

      .input-error {
        border-color: #EF4444;
      }

      .error-message {
        color: #EF4444;
        font-size: 12px;
        font-weight: 500;
        margin-top: 6px;
        text-align: left;
      }

      .password-toggle {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #E73C3C;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
      }

      .password-input-container {
        position: relative;
      }

      .reset-button {
        width: 100%;
        background: #E73C3C;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 8px rgba(231, 60, 60, 0.3);
        margin-top: 8px;
      }

      .reset-button:hover {
        background: #d63232;
        box-shadow: 0 6px 12px rgba(231, 60, 60, 0.4);
      }

      .reset-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .message {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
      }

      .success-message {
        background: #F0FDF4;
        color: #166534;
        border: 1px solid #BBF7D0;
      }

      .error-message-global {
        background: #FEF2F2;
        color: #991B1B;
        border: 1px solid #FECACA;
      }

      .info-message {
        background: #EFF6FF;
        color: #1E40AF;
        border: 1px solid #DBEAFE;
      }

      .links {
        text-align: center;
        margin-top: 24px;
      }

      .link {
        color: #E73C3C;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
      }

      .link:hover {
        text-decoration: underline;
      }

      .password-strength {
        margin-top: 8px;
        font-size: 12px;
        font-weight: 500;
      }

      .strength-weak { color: #EF4444; }
      .strength-medium { color: #F59E0B; }
      .strength-strong { color: #10B981; }

      @media (max-width: 480px) {
        .card {
          padding: 24px;
        }
        
        .title {
          fontSize: 24px;
        }
      }

  body
    .container
      .card
        //- Check for URL parameters first (client-side success/error)
        if (typeof success !== 'undefined' && success)
          .header
            .blood-drop ðŸ©¸
            h1.title Password Reset Successful
            p.subtitle= success
          .links
            p.link You can Login in your Blood Bank mobile app with your new password

        else if (typeof error !== 'undefined' && error)
          .header
            .blood-drop ðŸ©¸
            h1.title Reset Password
            p.subtitle Enter your new password below
          .message.error-message-global= error
          .links
            p.link Try Again

        //- Server-side rendered content (initial page load)
        else if success
          .header
            .blood-drop ðŸ©¸
            h1.title Password Reset Successful
            p.subtitle= success
          .links
            p.link You can Login in your Blood Bank mobile app with your new password

        else if error
          .header
            .blood-drop ðŸ©¸
            h1.title Reset Password
            p.subtitle Enter your new password below
          .message.error-message-global= error
          .links
            p.link Try Again in Blood Bank mobile app

        else
          .header
            .blood-drop ðŸ©¸
            h1.title Reset Password
            p.subtitle Enter your new password below

          if message
            .message.info-message= message

          form#resetForm
            input(type="hidden", name="token", value=token)

            .form-group
              label.label(for="password") New Password *
              .password-input-container
                input#password.input(
                  type="password",
                  name="password",
                  placeholder="Enter new password",
                  required,
                  minlength="6",
                  oninput="checkPasswordStrength(this.value)"
                )
                button.password-toggle(type="button", onclick="togglePassword('password')") Show
              #passwordStrength.password-strength
              #passwordError.error-message

            .form-group
              label.label(for="confirmPassword") Confirm Password *
              .password-input-container
                input#confirmPassword.input(
                  type="password",
                  name="confirmPassword",
                  placeholder="Confirm new password",
                  required,
                  minlength="6",
                  oninput="checkPasswordMatch()"
                )
                button.password-toggle(type="button", onclick="togglePassword('confirmPassword')") Show
              #confirmError.error-message

            button.reset-button(type="button", onclick="submitResetForm()", id="submitBtn")
              span#buttonText Reset Password
              span#buttonLoading.loading(style="display: none")

          .links
            p.link You can Login in your Blood Bank mobile app with your new password

  script.
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const toggle = input.parentNode.querySelector('.password-toggle');
      
      if (input.type === 'password') {
        input.type = 'text';
        toggle.textContent = 'Hide';
      } else {
        input.type = 'password';
        toggle.textContent = 'Show';
      }
    }

    function checkPasswordStrength(password) {
      const strengthText = document.getElementById('passwordStrength');
      const errorElement = document.getElementById('passwordError');
      
      if (!password) {
        strengthText.textContent = '';
        errorElement.textContent = '';
        return;
      }

      if (password.length < 6) {
        strengthText.textContent = 'Password must be at least 6 characters';
        strengthText.className = 'password-strength strength-weak';
        errorElement.textContent = 'Password must be at least 6 characters';
        return;
      }

      errorElement.textContent = '';

      // Simple strength check
      let strength = 'weak';
      if (password.length >= 8) {
        strength = 'medium';
      }
      if (password.length >= 10 && /[A-Z]/.test(password) && /[0-9]/.test(password)) {
        strength = 'strong';
      }

      const strengthMessages = {
        weak: 'Weak password',
        medium: 'Medium strength',
        strong: 'Strong password'
      };

      strengthText.textContent = strengthMessages[strength];
      strengthText.className = `password-strength strength-${strength}`;
    }

    function checkPasswordMatch() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorElement = document.getElementById('confirmError');

      if (!confirmPassword) {
        errorElement.textContent = '';
        return;
      }

      if (password !== confirmPassword) {
        errorElement.textContent = 'Passwords do not match';
      } else {
        errorElement.textContent = '';
      }
    }

    function validateForm() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const submitBtn = document.getElementById('submitBtn');

      const isValid = password.length >= 6 && password === confirmPassword;
      submitBtn.disabled = !isValid;
      
      return isValid;
    }

    // Real-time validation
    document.getElementById('password')?.addEventListener('input', validateForm);
    document.getElementById('confirmPassword')?.addEventListener('input', validateForm);

    async function submitResetForm() {
      if (!validateForm()) return;

      const submitBtn = document.getElementById('submitBtn');
      const buttonText = document.getElementById('buttonText');
      const buttonLoading = document.getElementById('buttonLoading');

      // Show loading state
      submitBtn.disabled = true;
      buttonText.style.display = 'none';
      buttonLoading.style.display = 'inline-block';

      try {
        const formData = {
          token: document.querySelector('input[name="token"]').value,
          password: document.getElementById('password').value
        };

        console.log('Sending reset request:', formData);

        const response = await fetch('/api/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();
        console.log('Reset response:', data);

        if (data.status === 'success') {
          // Redirect to same page with success parameter
          window.location.href = window.location.pathname + '?success=' + encodeURIComponent(data.message);
        } else {
          // Redirect to same page with error parameter
          window.location.href = window.location.pathname + '?error=' + encodeURIComponent(data.message);
        }

      } catch (error) {
        console.error('Error:', error);
        window.location.href = window.location.pathname + '?error=' + encodeURIComponent('Network error. Please try again.');
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        buttonText.style.display = 'inline-block';
        buttonLoading.style.display = 'none';
      }
    }

    // Initial validation
    validateForm();

    // Handle URL parameters on client side
    function handleUrlParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const success = urlParams.get('success');
      const error = urlParams.get('error');
      
      if (success || error) {
        // Remove parameters from URL without reloading
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Update the page content
        const card = document.querySelector('.card');
        if (success) {
          card.innerHTML = `
            <div class="header">
              <div class="blood-drop">ðŸ©¸</div>
              <h1 class="title">Password Reset Successful</h1>
              <p class="subtitle">${decodeURIComponent(success)}</p>
            </div>
            <div class="links">
              <p class="link">You can Login in your Blood Bank mobile app with your new password</p>
            </div>
          `;
        } else if (error) {
          card.innerHTML = `
            <div class="header">
              <div class="blood-drop">ðŸ©¸</div>
              <h1 class="title">Reset Password</h1>
              <p class="subtitle">Enter your new password below</p>
            </div>
            <div class="message error-message-global">
              ${decodeURIComponent(error)}
            </div>
            <div class="links">
              <p class="link">Try Again in Blood Bank mobile app</p>
            </div>
          `;
        }
      }
    }

    // Check for URL parameters when page loads
    document.addEventListener('DOMContentLoaded', handleUrlParameters);